<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS Interface</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;

            /* Main Semantic Colors */
            --accent-blue: #2196f3;   /* Input */
            --accent-yellow: #d38b00; /* Battery */
            --accent-green: #4caf50;  /* Output */
            --accent-slate: #78909c;  /* System/Internal (Converter, Charger, Test) */
            --accent-red: #f44336;    /* Critical/Backup Flow */

            --line-inactive: #444;
        }

        body.light-theme {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --line-inactive: #e0e0e0;
            --accent-slate: #90a4ae;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.3s, color 0.3s;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 950px;
            margin-bottom: 10px;
        }

        h1 { margin: 0; font-size: 1.4rem; font-weight: 400; }

        .theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--line-inactive);
            color: var(--text-main);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .container {
            max-width: 950px;
            width: 100%;
            display: grid;
            gap: 15px;
        }

        .panel {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }

        .panel-header {
            font-size: 0.9rem;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--line-inactive);
            padding-bottom: 5px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
        }

        /* SVG Sizing */
        .diagram-wrapper { width: 100%; line-height: 0; }
        svg { width: 100%; height: auto; display: block; user-select: none; pointer-events: none; }

        /* Block Styles */
        .svg-block {
            fill: var(--card-bg);
            stroke: var(--line-inactive);
            stroke-width: 2;
            transition: all 0.4s ease;
        }

        /* Active Block Highlights */
        .svg-block.active-blue { stroke: var(--accent-blue); fill: rgba(33, 150, 243, 0.1); }
        .svg-block.active-yellow { stroke: var(--accent-yellow); fill: rgba(255, 152, 0, 0.1); }
        .svg-block.active-green { stroke: var(--accent-green); fill: rgba(76, 175, 80, 0.1); }
        .svg-block.active-system { stroke: var(--accent-slate); fill: rgba(120, 144, 156, 0.1); }
        .svg-block.active-alert { stroke: var(--accent-red); fill: rgba(244, 67, 54, 0.1); }

        /* Text Styles */
        .svg-text-bold { fill: var(--text-main); font-size: 16px; font-weight: bold; text-anchor: middle; pointer-events: none; }
        .svg-text-desc { fill: var(--text-muted); font-size: 13px; text-anchor: middle; pointer-events: none; }
        .svg-text-data { fill: var(--text-main); font-size: 14px; font-weight: bold; text-anchor: middle; font-family: monospace; pointer-events: none; }

        /* Paths */
        .svg-path { fill: none; stroke: var(--line-inactive); stroke-width: 4; stroke-linecap: round; transition: stroke 0.3s; }

        /* Animation Classes */
        .anim-fwd { stroke-dasharray: 12, 8; animation: dash-fwd 1s linear infinite; }

        .stroke-blue { stroke: var(--accent-blue); }
        .stroke-yellow { stroke: var(--accent-yellow); }
        .stroke-red { stroke: var(--accent-red); }
        .stroke-green { stroke: var(--accent-green); }

        @keyframes dash-fwd { from { stroke-dashoffset: 20; } to { stroke-dashoffset: 0; } }

        /* --- ADAPTIVE LOGIC --- */
        .diagram-desktop { display: block; }
        .diagram-mobile { display: none; }

        @media (max-width: 768px) {
            .diagram-desktop { display: none; }
            .diagram-mobile { display: block; }
            .svg-text-bold { font-size: 18px; }
            .svg-text-data { font-size: 16px; }
        }

        /* Metrics */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .metric-card { background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--line-inactive); }
        .metric-card.input { border-color: var(--accent-blue); }
        .metric-card.battery { border-color: var(--accent-yellow); }
        .metric-card.output { border-color: var(--accent-green); }
        .metric-value { font-size: 1.6rem; font-weight: bold; margin: 4px 0; }
        .metric-sub { font-size: 0.9rem; color: var(--text-muted); }
        .battery-container { width: 100%; height: 14px; background: var(--line-inactive); border-radius: 3px; overflow: hidden; margin: 8px 0; }
        .battery-fill { height: 100%; background: var(--accent-green); transition: width 0.5s; }
        .status-badge { padding: 4px 10px; vertical-align: middle; border-radius: 4px; background: var(--line-inactive); font-weight: bold; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>UPS System <span id="sys-status" class="status-badge">...</span></h1>
        <button class="theme-toggle" id="theme-switch">Switch Theme</button>
    </div>

    <div class="container">

        <div class="panel">
            <div class="panel-header">Power Scheme</div>
            <div class="diagram-wrapper">

                <svg class="diagram-desktop" viewBox="0 0 900 280">
                    <path d="M 152 135 L 180 135" class="svg-path p-in-main" />
                    <path d="M 180 135 L 180 55 L 458 55" class="svg-path p-bypass" />
                    <path d="M 180 135 L 180 225 L 218 225" class="svg-path p-in-chg" />
                    <path d="M 392 225 L 458 225" class="svg-path p-chg-bat" />
                    <path d="M 545 178 L 545 102" class="svg-path p-bat-conv" />
                    <path d="M 632 55 L 688 55" class="svg-path p-out" />
                    <path d="M 632 225 L 688 225" class="svg-path p-bat-test" />

                    <rect x="10" y="90" width="140" height="90" rx="6" class="svg-block r-input" />
                    <text x="80" y="115" class="svg-text-bold">INPUT</text>
                    <text x="80" y="132" class="svg-text-desc">24V Source</text>
                    <text x="80" y="160" class="svg-text-data txt-in">--</text>

                    <rect x="220" y="180" width="170" height="90" rx="6" class="svg-block r-chg" />
                    <text x="305" y="205" class="svg-text-bold">CHARGER</text>
                    <text x="305" y="222" class="svg-text-desc">Buck Conv</text>
                    <text x="305" y="250" class="svg-text-data txt-chg">--</text>

                    <rect x="460" y="10" width="170" height="90" rx="6" class="svg-block r-conv" />
                    <text x="545" y="35" class="svg-text-bold">CONVERTER</text>
                    <text x="545" y="52" class="svg-text-desc">12V Reg</text>
                    <text x="545" y="80" class="svg-text-data txt-conv">--</text>

                    <rect x="460" y="180" width="170" height="90" rx="6" class="svg-block r-bat" />
                    <text x="545" y="205" class="svg-text-bold">BATTERY</text>
                    <text x="545" y="222" class="svg-text-desc">4S Li-Ion</text>
                    <text x="545" y="250" class="svg-text-data txt-bat">--</text>

                    <rect x="690" y="10" width="170" height="90" rx="6" class="svg-block r-out" />
                    <text x="775" y="35" class="svg-text-bold">OUTPUT</text>
                    <text x="775" y="52" class="svg-text-desc">Load</text>
                    <text x="775" y="80" class="svg-text-data txt-out">--</text>

                    <rect x="690" y="180" width="170" height="90" rx="6" class="svg-block r-test" />
                    <text x="775" y="205" class="svg-text-bold">TEST LOAD</text>
                    <text x="775" y="222" class="svg-text-desc">Dummy Load</text>
                    <text x="775" y="250" class="svg-text-data txt-test">--</text>
                </svg>

                <svg class="diagram-mobile" viewBox="0 0 800 340">
                    <path d="" class="svg-path p-in-main" style="display:none" />
                    <path d="M 232 75 L 288 75" class="svg-path p-bypass" />
                    <path d="M 120 142 L 120 198" class="svg-path p-in-chg" />
                    <path d="M 232 265 L 288 265" class="svg-path p-chg-bat" />
                    <path d="M 400 198 L 400 142" class="svg-path p-bat-conv" />
                    <path d="M 512 75 L 568 75" class="svg-path p-out" />
                    <path d="M 512 265 L 568 265" class="svg-path p-bat-test" />

                    <rect x="10" y="10" width="220" height="130" rx="8" class="svg-block r-input" />
                    <text x="120" y="45" class="svg-text-bold">INPUT</text>
                    <text x="120" y="70" class="svg-text-desc">24V DC Source</text>
                    <text x="120" y="105" class="svg-text-data txt-in">--</text>

                    <rect x="290" y="10" width="220" height="130" rx="8" class="svg-block r-conv" />
                    <text x="400" y="45" class="svg-text-bold">CONVERTER</text>
                    <text x="400" y="70" class="svg-text-desc">12V Regulator</text>
                    <text x="400" y="105" class="svg-text-data txt-conv">--</text>

                    <rect x="570" y="10" width="220" height="130" rx="8" class="svg-block r-out" />
                    <text x="680" y="45" class="svg-text-bold">OUTPUT</text>
                    <text x="680" y="70" class="svg-text-desc">Load</text>
                    <text x="680" y="105" class="svg-text-data txt-out">--</text>

                    <rect x="10" y="200" width="220" height="130" rx="8" class="svg-block r-chg" />
                    <text x="120" y="235" class="svg-text-bold">CHARGER</text>
                    <text x="120" y="260" class="svg-text-desc">Buck Converter</text>
                    <text x="120" y="295" class="svg-text-data txt-chg">--</text>

                    <rect x="290" y="200" width="220" height="130" rx="8" class="svg-block r-bat" />
                    <text x="400" y="235" class="svg-text-bold">BATTERY</text>
                    <text x="400" y="260" class="svg-text-desc">4S Li-Ion</text>
                    <text x="400" y="295" class="svg-text-data txt-bat">--</text>

                    <rect x="570" y="200" width="220" height="130" rx="8" class="svg-block r-test" />
                    <text x="680" y="235" class="svg-text-bold">TEST LOAD</text>
                    <text x="680" y="260" class="svg-text-desc">Dummy Load</text>
                    <text x="680" y="295" class="svg-text-data txt-test">--</text>
                </svg>

            </div>
        </div>

        <div class="panel">
            <div class="panel-header">Electrical Parameters</div>
            <div class="metrics-grid">
                <div class="metric-card input">
                    <div class="metric-sub">Input</div>
                    <div class="metric-value" id="v-in">--</div>
                    <div class="metric-sub"><span id="a-in">--</span>A | <span id="w-in">--</span>W</div>
                </div>
                <div class="metric-card battery">
                    <div class="metric-sub">Battery</div>
                    <div class="metric-value" id="v-bat">--</div>
                    <div class="battery-container"><div class="battery-fill" id="b-fill"></div></div>
                    <div class="metric-sub">SoC: <span id="soc">--</span>% | <span id="a-bat">--</span>A</div>
                </div>
                <div class="metric-card output">
                    <div class="metric-sub">Output</div>
                    <div class="metric-value" id="v-out">--</div>
                    <div class="metric-sub"><span id="a-out">--</span>A | <span id="w-out">--</span>W</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const getEls = (selector) => document.querySelectorAll(selector);

        const els = {
            vIn: document.getElementById('v-in'), aIn: document.getElementById('a-in'), wIn: document.getElementById('w-in'),
            vBat: document.getElementById('v-bat'), aBat: document.getElementById('a-bat'), soc: document.getElementById('soc'), bFill: document.getElementById('b-fill'),
            vOut: document.getElementById('v-out'), aOut: document.getElementById('a-out'), wOut: document.getElementById('w-out'),
            status: document.getElementById('sys-status'),

            txtIn: getEls('.txt-in'), txtChg: getEls('.txt-chg'), txtBat: getEls('.txt-bat'),
            txtConv: getEls('.txt-conv'), txtOut: getEls('.txt-out'), txtTest: getEls('.txt-test'),

            rIn: getEls('.r-input'), rChg: getEls('.r-chg'), rBat: getEls('.r-bat'),
            rConv: getEls('.r-conv'), rOut: getEls('.r-out'), rTest: getEls('.r-test'),

            pInMain: getEls('.p-in-main'), pBypass: getEls('.p-bypass'), pInChg: getEls('.p-in-chg'),
            pChgBat: getEls('.p-chg-bat'), pBatConv: getEls('.p-bat-conv'), pOut: getEls('.p-out'),
            pBatTest: getEls('.p-bat-test')
        };

        if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-theme');
        document.getElementById('theme-switch').onclick = () => {
            document.body.classList.toggle('light-theme');
            localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
        };

        // --- DATA SIMULATION ---
        let simState = 0;
        let tickCount = 0;
        let soc = 75.0;

        // Mock function to simulate fetching JSON from server
        function fetchUPSData() {
            // In real app: return fetch('/api/ups-status').then(r => r.json());

            // Simulation Logic
            tickCount++;
            if (tickCount % 6 === 0) simState = (simState + 1) % 6; // 6 states now

            const noise = () => (Math.random() - 0.5) * 0.15;

            // Default structure
            let json = {
                system: { status_text: "INIT", alert: false },
                input: { voltage: 0, current: 0, power: 0, connected: false },
                charger: { enabled: false, temperature: 35.0 },
                battery: { voltage: 0, current: 0, soc: 0, temperature: 25.0, health: 100 },
                converter: { active: false, source: 'none', temperature: 40.0 }, // source: 'input', 'battery', 'none'
                output: { voltage: 0, current: 0, power: 0, enabled: false },
                test_load: { enabled: false, temperature: 25.0, power: 0 }
            };

            const loadCurrent = 3.5 + noise();
            const loadVoltage = 12.0 + noise();

            // --- State Machine ---
            switch (simState) {
                case 0: // CHARGING (Mains OK, Charger ON, Output on Input)
                    json.system.status_text = "CHARGING";
                    json.input.connected = true;
                    json.input.voltage = 24.2 + noise();
                    json.charger.enabled = true;
                    json.converter.active = true;
                    json.converter.source = 'input';
                    json.output.enabled = true;

                    if (soc < 98) { soc += 0.5; json.battery.current = 1.5; }
                    else { json.battery.current = 0.1; } // Float

                    json.battery.voltage = 13.5 + (soc/100 * 3.0);
                    // Input Power = Output + Charging
                    const pOut = loadVoltage * loadCurrent;
                    const pChg = json.battery.voltage * json.battery.current;
                    json.input.power = (pOut + pChg) / 0.9;
                    json.input.current = json.input.power / json.input.voltage;
                    break;

                case 1: // FULL / STANDBY (Mains OK, Charger Float, Output on Input)
                    json.system.status_text = "ONLINE";
                    json.input.connected = true;
                    json.input.voltage = 24.1 + noise();
                    json.charger.enabled = false; // Still enabled but float
                    json.converter.active = true;
                    json.converter.source = 'input';
                    json.output.enabled = true;

                    json.battery.current = 0.05; // Trickle
                    json.battery.voltage = 16.5; // Full 4S
                    json.input.current = (loadVoltage * loadCurrent) / 0.92 / json.input.voltage;
                    break;

                case 2: // BACKUP (Mains Fail, Output on Battery)
                    json.system.status_text = "BACKUP";
                    json.system.alert = true;
                    json.input.connected = false;
                    json.input.voltage = 0;
                    json.charger.enabled = false;
                    json.converter.active = true;
                    json.converter.source = 'battery';
                    json.output.enabled = true;

                    soc -= 0.6;
                    json.battery.current = -1 * (loadVoltage * loadCurrent / 0.9 / 14.0);
                    json.battery.voltage = 14.0 + (soc/100 * 2.5);
                    break;

                case 3: // TEST (Mains OK, Output on Input, Bat on Test)
                    json.system.status_text = "SELF TEST";
                    json.input.connected = true;
                    json.input.voltage = 24.2 + noise();
                    json.charger.enabled = false;
                    json.converter.active = true;
                    json.converter.source = 'input'; // Load powered by mains
                    json.output.enabled = true;
                    json.test_load.enabled = true;

                    soc -= 0.4;
                    json.battery.current = -2.5; // Test discharge
                    json.battery.voltage = 14.0 + (soc/100 * 2.5) - 0.2;
                    json.test_load.power = Math.abs(json.battery.voltage * json.battery.current);

                    json.input.current = (loadVoltage * loadCurrent) / 0.92 / json.input.voltage;
                    break;

                case 4: // INPUT IDLE (Mains Present but Switches Open - No flow)
                    json.system.status_text = "INPUT IDLE";
                    json.input.connected = true; // Voltage detected
                    json.input.voltage = 24.0 + noise();
                    json.charger.enabled = false; // Switch open
                    json.converter.active = true;
                    json.converter.source = 'battery'; // Running on bat despite input present
                    json.output.enabled = true;

                    soc -= 0.6;
                    json.battery.current = -1 * (loadVoltage * loadCurrent / 0.9 / 14.0);
                    json.battery.voltage = 14.0 + (soc/100 * 2.5);
                    break;

                case 5: // BACKUP + TEST (Mains Fail, Output on Battery, Bat on Test) (WTF is going on?!)
                    json.system.status_text = "BACKUP SELF TEST";
                    json.input.connected = false;
                    json.input.voltage = 0;
                    json.charger.enabled = false;
                    json.converter.active = true;
                    json.converter.source = 'battery';
                    json.output.enabled = true;
                    json.test_load.enabled = true;

                    soc -= 1;
                    json.battery.current = -3.5 * (loadVoltage * loadCurrent / 0.9 / 14.0);
                    json.battery.voltage = 14.0 + (soc/100 * 2.5);
                    json.test_load.power = Math.abs(json.battery.voltage * json.battery.current);
                    break;
            }

            // Common assignments
            json.battery.soc = Math.min(100, Math.max(0, soc));
            json.output.voltage = json.output.enabled ? loadVoltage : 0;
            json.output.current = json.output.enabled ? loadCurrent : 0;
            json.output.power = json.output.voltage * json.output.current;
            json.input.power = json.input.voltage * json.input.current;

            json.charger.power = json.charger.enabled ? (json.battery.voltage * Math.max(0, json.battery.current)) : 0;
            json.converter.power = json.converter.active ? json.output.power : 0;

            return Promise.resolve(json);
        }

        // --- VISUALIZATION UPDATE ---
        function updateVisuals(data) {
            // 1. Text Metrics
            els.status.innerText = data.system.status_text;
            els.status.style.color = data.system.alert ? 'var(--accent-red)' : 'var(--text-main)';

            const setTxt = (list, val) => list.forEach(el => el.textContent = val);

            // Input
            els.vIn.innerText = data.input.voltage.toFixed(1) + ' V';
            els.aIn.innerText = data.input.current.toFixed(1);
            els.wIn.innerText = data.input.power.toFixed(0);
            setTxt(els.txtIn, `${data.input.voltage.toFixed(1)}V / ${data.input.current.toFixed(1)}A`);

            // Charger
            setTxt(els.txtChg, `${data.charger.power.toFixed(0)}W / ${data.charger.temperature.toFixed(0)}째C`);

            // Battery
            els.vBat.innerText = data.battery.voltage.toFixed(1) + ' V';
            els.aBat.innerText = data.battery.current.toFixed(1);
            els.soc.innerText = data.battery.soc.toFixed(0);
            els.bFill.style.width = data.battery.soc + '%';
            // Determine Bat color based on SoC
            let batColor = 'var(--accent-green)';
            if(data.battery.soc < 30) batColor = 'var(--accent-yellow)';
            if(data.battery.soc < 15) batColor = 'var(--accent-red)';
            els.bFill.style.backgroundColor = batColor;

            setTxt(els.txtBat, `${data.battery.voltage.toFixed(1)}V / ${data.battery.current.toFixed(1)}A / ${data.battery.temperature.toFixed(0)}째C`);

            // Converter
            setTxt(els.txtConv, `${data.converter.power.toFixed(0)}W / ${data.converter.temperature.toFixed(0)}째C`);

            // Output
            els.vOut.innerText = data.output.voltage.toFixed(1) + ' V';
            els.aOut.innerText = data.output.current.toFixed(1);
            els.wOut.innerText = data.output.power.toFixed(0);
            setTxt(els.txtOut, `${data.output.voltage.toFixed(1)}V / ${data.output.current.toFixed(1)}A`);

            // Test
            setTxt(els.txtTest, `${data.test_load.power.toFixed(0)}W / ${data.test_load.temperature.toFixed(0)}째C`);


            // 2. BLOCK HIGHLIGHTS
            // Helper to reset and set classes
            const updateBlock = (list, isActive, activeClass) => {
                list.forEach(el => {
                    // Remove all active classes
                    el.classList.remove('active-blue', 'active-yellow', 'active-green', 'active-system', 'active-alert');
                    el.classList.remove('svg-block'); // temp remove base to avoid toggle issues? no, keep it
                    el.classList.add('svg-block'); // ensure base
                    if (isActive) el.classList.add(activeClass);
                });
            };

            updateBlock(els.rIn, data.input.connected, 'active-blue');
            updateBlock(els.rChg, data.charger.enabled, 'active-system');

            // Battery is "active" if there is current flow OR we are in backup mode
            const batActive = Math.abs(data.battery.current) > 0.1 || data.converter.source === 'battery';
            updateBlock(els.rBat, batActive, 'active-yellow');

            updateBlock(els.rConv, data.converter.active, 'active-system');
            updateBlock(els.rOut, data.output.enabled, 'active-green');
            updateBlock(els.rTest, data.test_load.enabled, 'active-system');


            // 3. PATH ANIMATIONS
            const updatePath = (list, condition, colorClass, animationClass = 'anim-fwd') => {
                list.forEach(el => {
                    el.setAttribute('class', 'svg-path'); // Reset
                    if (condition) {
                        el.classList.add(animationClass, colorClass);
                    }
                });
            };

            // Input -> Main Split
            // Logic: Input connected AND (Charger taking power OR Converter taking power from input)
            const inputFlowing = data.input.connected && (data.charger.enabled || data.converter.source === 'input');
            updatePath(els.pInMain, inputFlowing, 'stroke-blue');

            // Split -> Converter (Bypass)
            updatePath(els.pBypass, data.converter.source === 'input', 'stroke-blue');

            // Split -> Charger
            updatePath(els.pInChg, data.charger.enabled, 'stroke-blue');

            // Charger -> Battery
            updatePath(els.pChgBat, data.charger.enabled, 'stroke-yellow');

            // Battery -> Converter (Backup)
            updatePath(els.pBatConv, data.converter.source === 'battery', 'stroke-yellow');

            // Converter -> Output
            updatePath(els.pOut, data.output.enabled, 'stroke-green');

            // Battery -> Test Load
            updatePath(els.pBatTest, data.test_load.enabled, 'stroke-yellow');
        }

        // --- MAIN LOOP ---
        function tick() {
            fetchUPSData().then(data => updateVisuals(data));
        }

        setInterval(tick, 1000);
        tick();

    </script>
</body>
</html>